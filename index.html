<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Pixel Canvas</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Press Start 2P font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body { 
            font-family: 'Press Start 2P', cursive; 
        }

        /* Custom styles for the grid */
        #pixel-grid {
            display: grid;
            width: 100%;
            height: 100%;
            grid-template-columns: var(--grid-columns);
            grid-template-rows: var(--grid-columns);
            aspect-ratio: 1 / 1;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #f3f4f6; /* Light gray background */
        }

        .pixel-cell {
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: background-color 0.1s;
            /* Only show crosshair cursor if signed in */
            cursor: pointer; 
        }

        /* Ensure inputs, modals, and user info use a readable font */
        .readable-font {
            font-family: 'Inter', sans-serif;
        }
        
        .btn-style {
            transition: all 0.15s ease-in-out;
            transform: translateY(0);
        }
        .btn-style:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-style:active {
            transform: translateY(1px);
        }

        .grid-container {
            max-width: 90vw;
            width: 100%;
        }

        @media (min-width: 768px) {
            .grid-container {
                max-width: 600px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center p-4 min-h-screen">

    <div class="w-full max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-700">Real-Time Pixel Canvas</h1>
            <p class="text-gray-500 mt-3 text-xs readable-font">Collaborate on a single, shared canvas.</p>
            
            <!-- Authentication Status and Controls -->
            <div id="auth-controls" class="mt-4 flex flex-col items-center gap-3 readable-font">
                <!-- User ID display for collaboration -->
                <div id="user-info" class="text-xs text-gray-700 p-2 bg-white rounded-lg shadow-inner w-full sm:w-auto border border-gray-200">
                    Awaiting connection...
                </div>
                
                <!-- Email/Password Auth -->
                <div id="email-auth-area" class="w-full max-w-xs p-4 bg-white rounded-xl shadow-md border border-gray-100 grid grid-cols-2 gap-2">
                    <input type="email" id="email-input" placeholder="Email" class="col-span-2 p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="password" id="password-input" placeholder="Password" class="col-span-2 p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    
                    <button id="sign-up-btn" class="py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 btn-style text-xs">
                        Sign Up
                    </button>
                    <button id="email-sign-in-btn" class="py-2 bg-indigo-700 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-800 transition duration-150 btn-style text-xs">
                        Sign In
                    </button>
                </div>

                <!-- Anonymous and Google Auth -->
                <div class="flex flex-wrap justify-center gap-2 mt-2 w-full max-w-xs">
                    <button id="google-sign-in-btn" class="flex-1 py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 btn-style text-xs min-w-[120px]">
                        Google Sign In
                    </button>
                    <button id="anonymous-sign-in-btn" class="flex-1 py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-150 btn-style text-xs min-w-[120px]">
                        Anonymous Sign In
                    </button>
                    <button id="sign-out-btn" class="w-full py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition duration-150 hidden btn-style text-xs mt-2">
                        Sign Out
                    </button>
                </div>
                
            </div>
        </header>

        <!-- Controls Panel -->
        <div class="bg-white p-5 md:p-8 rounded-xl shadow-2xl mb-6 border border-indigo-100 flex flex-col gap-4">
            
            <!-- Grid and Color Pickers -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                
                <!-- Color Picker -->
                <div class="col-span-1">
                    <label for="color-picker" class="block text-xs font-medium text-gray-700 mb-2">Current Color</label>
                    <input type="color" id="color-picker" value="#ff0000" class="w-full h-10 border border-gray-300 rounded-lg p-1 shadow-sm transition duration-150 ease-in-out hover:shadow-md cursor-pointer readable-font">
                </div>

                <!-- Grid Size Input (Read-only after initialization) -->
                <div class="col-span-1">
                    <label for="grid-size" class="block text-xs font-medium text-gray-700 mb-2">Grid Size (N x N)</label>
                    <input type="number" id="grid-size" value="32" min="8" max="64" class="w-full h-10 border border-gray-300 bg-gray-200 rounded-lg p-2 text-center shadow-inner text-gray-500 readable-font" readonly>
                </div>

                <!-- Clear Button -->
                <div class="col-span-1 flex items-end">
                    <button id="clear-btn" class="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 ease-in-out text-xs btn-style">
                        Clear Canvas
                    </button>
                </div>
            </div>

            <!-- Status Message -->
            <p class="text-center text-sm text-indigo-500 mt-2 text-xs">
                <span id="draw-status-message">Sign in to start drawing!</span> Changes are synced immediately.
            </p>
        </div>
        
        <!-- Canvas Area -->
        <div class="flex justify-center grid-container mx-auto">
            <div id="pixel-grid" class="border border-gray-500 rounded-xl overflow-hidden shadow-2xl">
                <!-- Grid cells will be injected here by JS -->
                <div class="flex items-center justify-center h-full text-gray-400 text-sm">
                    Connecting to shared canvas...
                </div>
            </div>
        </div>
        
    </div>

    <!-- Message Modal -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-3xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0 readable-font" id="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-indigo-700"></h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            <button id="modal-close-btn" class="w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition btn-style">Close</button>
        </div>
    </div>


    <!-- Firebase Core and Services -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut,
            signInAnonymously,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let unsubscribeSnapshot = null; 

        // Application State
        let currentColor = document.getElementById('color-picker').value;
        let gridSize = 32; 
        const PIXEL_ART_COLLECTION = 'pixel_art';
        const SHARED_CANVAS_DOC_ID = 'shared_canvas_001'; 

        // DOM elements
        const gridContainer = document.getElementById('pixel-grid');
        const colorPicker = document.getElementById('color-picker');
        const sizeInput = document.getElementById('grid-size');
        const clearBtn = document.getElementById('clear-btn');
        const userInfo = document.getElementById('user-info');
        const signUpBtn = document.getElementById('sign-up-btn');
        const emailSignInBtn = document.getElementById('email-sign-in-btn');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const anonymousSignInBtn = document.getElementById('anonymous-sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const drawStatusMessage = document.getElementById('draw-status-message');
        
        // Modal elements
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- Utility Functions ---

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalContainer.classList.remove('flex');
                modalContainer.classList.add('hidden');
            }, 300);
        }

        /** Updates the UI based on the current authentication state. */
        function updateUI(user) {
            const authArea = document.getElementById('email-auth-area');
            if (user) {
                // User is authenticated (Google, Email, or Anonymous)
                let displayName = user.email ? user.email : user.isAnonymous ? 'Anonymous' : 'Authenticated';
                userId = user.uid;
                
                userInfo.innerHTML = `You are: <span class="font-bold text-indigo-600">${displayName}</span> | ID: <span class="font-mono text-xs text-indigo-500">${userId.substring(0, 8)}...</span>`;
                drawStatusMessage.textContent = "You can draw!";
                clearBtn.disabled = false;
                
                // Hide sign-in options, show sign-out
                authArea.classList.add('hidden');
                googleSignInBtn.classList.add('hidden');
                anonymousSignInBtn.classList.add('hidden');
                signOutBtn.classList.remove('hidden');

            } else {
                // User is unauthenticated (signed out)
                userId = null;
                userInfo.textContent = "You are currently viewing only.";
                drawStatusMessage.textContent = "Sign in to start drawing!";
                clearBtn.disabled = true; // Prevent unauthenticated users from clearing the board
                
                // Show sign-in options, hide sign-out
                authArea.classList.remove('hidden');
                googleSignInBtn.classList.remove('hidden');
                anonymousSignInBtn.classList.remove('hidden');
                signOutBtn.classList.add('hidden');
            }
        }

        // --- Authentication Handlers ---

        async function handleEmailSignUp() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || password.length < 6) {
                showModal("Input Error", "Please provide a valid email and a password of at least 6 characters.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showModal("Success!", "Account created and signed in successfully. Happy drawing!");
            } catch (error) {
                console.error("Sign Up Error:", error);
                showModal("Sign Up Failed", `Error creating account: ${error.message}`);
            }
        }

        async function handleEmailSignIn() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showModal("Input Error", "Please enter both email and password.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showModal("Success!", "Signed in with email/password. Happy drawing!");
            } catch (error) {
                console.error("Sign In Error:", error);
                showModal("Sign In Failed", `Error signing in: ${error.message}`);
            }
        }

        async function handleGoogleSignIn() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showModal("Success!", "Signed in with Google. Happy drawing!");
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showModal("Sign-In Failed", `Could not sign in with Google: ${error.message}`);
            }
        }

        async function handleAnonymousSignIn() {
            if (!auth) return;
            try {
                await signInAnonymously(auth);
                showModal("Welcome!", "You are signed in anonymously and can now collaborate.");
            } catch (error) {
                console.error("Anonymous Sign-In Error:", error);
                showModal("Sign-In Failed", `Could not sign in anonymously: ${error.message}`);
            }
        }

        async function handleSignOut() {
            if (!auth) return;
            try {
                await signOut(auth);
                showModal("Signed Out", "You are now viewing the canvas only.");
            } catch (error) {
                console.error("Sign-Out Error:", error);
                showModal("Sign-Out Failed", `Error during sign-out: ${error.message}`);
            }
        }

        // --- Firebase Setup ---

        /** Generates the document path for the single shared canvas. */
        function getArtDocRef() {
            if (!db) return null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Public path for collaborative data
            return doc(db, 'artifacts', appId, 'public', 'data', PIXEL_ART_COLLECTION, SHARED_CANVAS_DOC_ID);
        }

        async function setupFirebase() {
            setLogLevel('debug');

            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!Object.keys(firebaseConfig).length) {
                    throw new Error("Firebase configuration is missing.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Attempt to sign in with the custom token if provided (e.g., from Canvas environment)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } 
                // CRITICAL CHANGE: DO NOT call signInAnonymously here. 
                // Allow the user to remain unauthenticated (null) so they can only view.

                // Auth state change listener (always runs to update UI and manage real-time sync)
                onAuthStateChanged(auth, (user) => {
                    updateUI(user);
                    
                    // The onSnapshot listener starts whether 'user' is null or not,
                    // allowing everyone to view the latest state.
                    if (db) {
                        startRealTimeCanvasSync();
                    }
                    console.log("Firebase Auth State changed. Current User ID:", user ? user.uid : 'None (Viewer only)');
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                userInfo.textContent = "Error initializing Firebase. See console.";
                showModal("Setup Error", "Failed to initialize the database. Real-time features may be limited.");
            }
        }

        // --- Canvas Drawing and Real-Time Sync ---

        /** Renders the grid based on the provided art data or initializes a new one. */
        function renderGrid(artData) {
            const newSize = artData.size || gridSize;
            const colors = artData.colors || Array(newSize * newSize).fill('#ffffff');

            gridSize = newSize;
            sizeInput.value = newSize;

            // 1. Recreate the grid structure if size changed or if it's empty
            if (gridContainer.children.length !== (newSize * newSize)) {
                gridContainer.innerHTML = '';
                gridContainer.style.setProperty('--grid-columns', `repeat(${newSize}, 1fr)`);

                for (let i = 0; i < newSize * newSize; i++) {
                    const cell = document.createElement('div');
                    cell.classList.add('pixel-cell');
                    cell.dataset.index = i;
                    gridContainer.appendChild(cell);
                }
            }

            // 2. Apply colors to all cells
            const cells = gridContainer.querySelectorAll('.pixel-cell');
            cells.forEach((cell, i) => {
                if (i < colors.length) {
                    cell.style.backgroundColor = colors[i];
                }
            });
        }

        /** Clears the canvas and updates the change in Firestore. (Requires sign-in) */
        async function clearCanvas() {
            if (!userId) {
                showModal("Access Denied", "You must be signed in to clear the shared canvas.");
                return;
            }

            const docRef = getArtDocRef();
            if (!docRef) return;

            const emptyColors = Array(gridSize * gridSize).fill('#ffffff');

            try {
                await setDoc(docRef, {
                    size: gridSize,
                    colors: emptyColors,
                    timestamp: new Date().toISOString(),
                    lastEditor: userId
                });
            } catch (error) {
                console.error("Error clearing canvas:", error);
                showModal("Clear Error", `Failed to clear canvas: ${error.message}`);
            }
        }

        /** Updates a single pixel in the Firebase document. (Requires sign-in) */
        async function updateSinglePixel(cellIndex, newColor) {
            // Check again inside the async function just in case
            if (!userId) return; 

            const docRef = getArtDocRef();
            if (!docRef) return;

            const cells = gridContainer.querySelectorAll('.pixel-cell');
            let currentColors = Array.from(cells).map(cell => cell.style.backgroundColor);
            
            if (cellIndex < currentColors.length) {
                currentColors[cellIndex] = newColor;

                try {
                    await setDoc(docRef, {
                        size: gridSize,
                        colors: currentColors,
                        timestamp: new Date().toISOString(),
                        lastEditor: userId
                    });
                } catch (error) {
                    console.error("Error updating pixel:", error);
                }
            }
        }
        
        /** Handles painting a cell and updates Firestore. */
        function handlePaint(event) {
            // CRITICAL CHECK: User must be signed in to paint
            if (!userId) return; 

            let target = event.target;
            
            if (target.classList.contains('pixel-cell')) {
                const cellIndex = parseInt(target.dataset.index);
                const newColor = currentColor;

                // 1. Optimistically update local UI
                target.style.backgroundColor = newColor;

                // 2. Asynchronously update Firestore
                updateSinglePixel(cellIndex, newColor);
            }
        }

        /** Starts the Firestore real-time listener (View-only mode for unauthenticated users). */
        function startRealTimeCanvasSync() {
            // If listener is already running, do nothing
            if (unsubscribeSnapshot) return;
            
            const docRef = getArtDocRef();
            if (!docRef) return;

            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const artData = docSnap.data();
                    renderGrid(artData);
                } else {
                    // Document doesn't exist, initialize locally for viewer,
                    // and try to save initial state if we are authenticated.
                    renderGrid({ size: gridSize, colors: Array(gridSize * gridSize).fill('#ffffff') });
                    
                    if (userId) { // Only attempt to create if a user is signed in
                        setDoc(docRef, {
                            size: gridSize,
                            colors: Array(gridSize * gridSize).fill('#ffffff'),
                            timestamp: new Date().toISOString(),
                            lastEditor: userId
                        }).catch(e => console.error("Error creating initial canvas:", e));
                    }
                }
            }, (error) => {
                console.error("Firestore Real-time Listener Error:", error);
                showModal("Real-time Error", "Lost connection to the shared canvas. Check your internet connection.");
            });
        }

        // --- Event Listeners ---

        function setupListeners() {
            colorPicker.addEventListener('input', (e) => {
                currentColor = e.target.value;
            });
            
            clearBtn.addEventListener('click', clearCanvas);

            // Authentication Bindings
            signUpBtn.addEventListener('click', handleEmailSignUp);
            emailSignInBtn.addEventListener('click', handleEmailSignIn);
            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            anonymousSignInBtn.addEventListener('click', handleAnonymousSignIn);
            signOutBtn.addEventListener('click', handleSignOut);
            
            // Painting Logic (Delegated event listeners)
            let isDrawing = false;
            
            gridContainer.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left click only
                    // CRITICAL CHECK: Block drawing if not signed in
                    if (!userId) {
                        showModal("Access Denied", "You must be signed in (Google, Email, or Anonymous) to draw on the shared canvas.");
                        return;
                    }
                    isDrawing = true;
                    handlePaint(e);
                }
            });

            gridContainer.addEventListener('mousemove', (e) => {
                if (isDrawing) {
                    handlePaint(e);
                }
            });

            document.addEventListener('mouseup', () => {
                isDrawing = false;
            });

            // Touch events for mobile drawing
            gridContainer.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                // CRITICAL CHECK: Block drawing if not signed in
                if (!userId) {
                    showModal("Access Denied", "You must be signed in to draw.");
                    return;
                }
                isDrawing = true;
                handlePaint(e.touches[0]);
            }, { passive: false });

            gridContainer.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (isDrawing) {
                    handlePaint(e.touches[0]);
                }
            }, { passive: false });

            gridContainer.addEventListener('touchend', () => {
                isDrawing = false;
            });
            
            // Modal Close
            modalCloseBtn.addEventListener('click', closeModal);
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer) {
                    closeModal();
                }
            });
        }

        // --- Initialization ---

        window.onload = function () {
            sizeInput.value = gridSize;
            sizeInput.setAttribute('readonly', 'true');
            
            setupFirebase();
            setupListeners();
        };

    </script>
</body>
</html>
