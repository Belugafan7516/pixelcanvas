<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Pixel Canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --pixel-size: 20px;
            --grid-size: 25;
            --canvas-width: calc(var(--pixel-size) * var(--grid-size));
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        #canvas-grid {
            display: grid;
            grid-template-columns: repeat(var(--grid-size), var(--pixel-size));
            grid-template-rows: repeat(var(--grid-size), var(--pixel-size));
            width: var(--canvas-width);
            height: var(--canvas-width);
            border: 5px solid #58a6ff; /* Neon blue border */
            box-shadow: 0 0 20px rgba(88, 166, 255, 0.5);
            margin: auto;
            image-rendering: pixelated;
        }
        .pixel {
            width: var(--pixel-size);
            height: var(--pixel-size);
            background-color: #FFFFFF; /* Default white background */
            cursor: crosshair;
            transition: background-color 0.05s ease-out;
            border: 1px solid #30363d;
        }
        /* Mobile responsiveness adjustments */
        @media (max-width: 768px) {
            :root {
                --pixel-size: 13px; /* Smaller pixels on mobile */
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-[#58a6ff] mb-2 drop-shadow-lg">Collaborative Pixel Art</h1>
            <p id="user-status" class="text-sm font-medium text-gray-400">Connecting to Firebase...</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Controls Column -->
            <div class="col-span-1 space-y-6 order-2 lg:order-1">
                <div class="card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-[#79c0ff]">Tools & Color</h2>
                    
                    <!-- Color Picker -->
                    <div class="mb-4">
                        <label for="color-picker" class="block text-sm font-medium mb-2">Select Paint Color</label>
                        <input type="color" id="color-picker" value="#ff3366" class="w-full h-12 p-1 border-2 border-[#58a6ff] rounded-lg cursor-pointer transform hover:scale-[1.02] transition duration-200">
                    </div>

                    <!-- Erase Button -->
                    <button id="eraser-button" class="w-full p-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                        </svg>
                        Select Eraser (Loses Score)
                    </button>
                    
                    <!-- Re-Authenticate Button -->
                    <button id="reauth-button" class="w-full p-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0114.743 3.03l-1.63-.487A5.002 5.002 0 005.999 5.05V7a1 1 0 01-2 0V3a1 1 0 011-1zm12.743 10.97a7.002 7.002 0 01-14.743-3.03l1.63.487A5.002 5.002 0 0014.001 14.95V13a1 1 0 012 0v4a1 1 0 01-1 1h-4a1 1 0 110-2h2.101A7.002 7.002 0 013.257 8.005l1.63.487z" clip-rule="evenodd" />
                        </svg>
                        Re-Authenticate (Check Ban Status)
                    </button>

                    <p class="text-xs text-gray-400 mt-3 text-center">
                        Current Tool: <span id="current-color-display" class="font-bold text-[#ff3366]">#FF3366</span>
                    </p>
                </div>

                <!-- User Info -->
                <div class="card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-[#ffcc33]">Your Contribution</h2>
                    <p class="text-sm font-medium break-words text-gray-400 mb-2">
                        <span class="font-bold text-[#79c0ff]">User ID:</span> 
                        <span id="user-id-display" class="text-xs italic text-gray-500">Loading...</span>
                    </p>
                    <div class="mt-4 p-3 bg-[#ffcc33] text-[#161b22] rounded-lg text-center">
                        <div class="text-lg font-semibold">Your Score</div>
                        <div id="user-score-display" class="text-5xl font-black">0</div>
                    </div>
                </div>

            </div>

            <!-- Canvas Column -->
            <div class="col-span-1 lg:col-span-1 flex justify-center items-start order-1 lg:order-2">
                <div id="canvas-grid" class="rounded-xl overflow-hidden">
                    <!-- Pixels will be dynamically generated here -->
                </div>
            </div>

            <!-- Leaderboard Column -->
            <div class="col-span-1 space-y-6 order-3 lg:order-3">
                <div class="card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-[#4cd964]">Top Artists</h2>
                    <ol id="leaderboard-list" class="space-y-3 text-gray-300">
                        <li class="text-sm italic text-gray-500">No scores yet...</li>
                    </ol>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state and Constants
        const GRID_SIZE = 25;
        const BG_COLOR = '#FFFFFF';
        let currentColor = document.getElementById('color-picker').value;
        let auth, db;
        let userId = null;
        let pixelGrid = Array(GRID_SIZE * GRID_SIZE).fill(0).map(() => ({ color: BG_COLOR, userId: null }));
        let isAuthReady = false;
        let isAuthListenerActive = false; // Flag to prevent multiple listeners

        // Configuration and Initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupAuthListener(); // Start the listener right away
        } else {
            document.getElementById('user-status').textContent = "ERROR: Firebase config missing.";
            console.error("Firebase configuration is missing.");
        }
        
        // --- Utility Functions ---

        const getCanvasDocRef = () => {
            return doc(db, `artifacts/${appId}/public/data/canvas_state/current`);
        };

        const getLeaderboardDocRef = (uid) => {
            return doc(db, `artifacts/${appId}/public/data/leaderboard/${uid}`);
        };


        /**
         * Sets up the permanent authentication state listener.
         * This function runs once to attach the listener.
         */
        function setupAuthListener() {
            if (isAuthListenerActive || !auth) return;
            isAuthListenerActive = true;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // 1. User is successfully authenticated (either token or anonymous)
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    document.getElementById('user-status').textContent = `Connected! User ID: ${userId.substring(0, 8)}...`;
                    isAuthReady = true;

                    // Start listeners only after auth is ready
                    setupCanvasListener();
                    setupLeaderboardListener();

                } else {
                    // 2. User is signed out or status is unknown. Attempt to sign in.
                    signInUser();
                }
            });
        }
        
        /**
         * Attempts to sign the user in using the available token or anonymously.
         */
        async function signInUser() {
            if (!auth) return;
            
            document.getElementById('user-status').textContent = "Attempting sign-in...";
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error during authentication:", error);
                // This block runs if the sign-in attempt fails (e.g., custom token revoked/invalid)
                document.getElementById('user-status').textContent = "Authentication Failed (Potentially Banned/Token Invalid).";
                isAuthReady = false; // Block writes if auth failed
            }
        }
        
        /**
         * Signs the user out and attempts to sign them back in immediately.
         * Useful for checking if a ban has been lifted.
         */
        async function reAuthenticate() {
            if (!auth) return;
            document.getElementById('user-status').textContent = "Re-authenticating...";
            isAuthReady = false;
            userId = null;
            try {
                // Ensure a full sign-out before retrying sign-in
                await signOut(auth);
                // onAuthStateChanged listener will automatically call signInUser() next.
            } catch (error) {
                console.error("Error during sign-out:", error);
            }
        }


        /**
         * Renders the entire pixel grid based on the current state.
         */
        function renderCanvas() {
            const canvasGrid = document.getElementById('canvas-grid');
            const pixelElements = canvasGrid.querySelectorAll('.pixel');

            if (pixelElements.length === 0) {
                // Initial render: create all the elements
                canvasGrid.innerHTML = '';
                pixelGrid.forEach((pixel, index) => {
                    const pixelDiv = document.createElement('div');
                    pixelDiv.classList.add('pixel');
                    pixelDiv.style.backgroundColor = pixel.color || BG_COLOR;
                    
                    // Add click listener
                    pixelDiv.addEventListener('click', () => {
                        updateSinglePixelAndScore(index, currentColor);
                    });

                    canvasGrid.appendChild(pixelDiv);
                });
            } else {
                // Update existing elements for better performance
                pixelGrid.forEach((pixel, index) => {
                    pixelElements[index].style.backgroundColor = pixel.color || BG_COLOR;
                });
            }
        }

        /**
         * Attaches a real-time listener to the canvas document.
         */
        function setupCanvasListener() {
            // Note: Listener is only set up once per session and requires 'db'.
            if (!db) return;
            const docRef = getCanvasDocRef();
            // This listener persists, even if the user signs out, it's tied to the global db instance.
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    if (data.pixels) {
                        try {
                            const newPixels = JSON.parse(data.pixels);
                            pixelGrid = newPixels;
                            renderCanvas();
                            // console.log("Canvas updated from Firestore.");
                        } catch (e) {
                            console.error("Error parsing pixel data:", e);
                        }
                    }
                } else {
                    // console.log("Canvas document does not exist. Initializing local state.");
                    renderCanvas(); 
                }
            }, (error) => {
                console.error("Error setting up canvas listener (read blocked, likely by ban/rules):", error);
            });
        }


        /**
         * Updates a single pixel and adjusts the user's score based on the action (paint or erase).
         */
        async function updateSinglePixelAndScore(cellIndex, newColor) {
            if (!isAuthReady || !userId || !db) {
                document.getElementById('user-status').textContent = "Authentication Required to Paint!";
                console.warn("Write blocked: Authentication not ready or missing database.");
                return;
            }

            const docRef = getCanvasDocRef();

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(docRef);
                    let pixelsData = JSON.parse(JSON.stringify(pixelGrid)); 

                    if (docSnapshot.exists()) {
                        try {
                            pixelsData = JSON.parse(docSnapshot.data().pixels);
                        } catch (e) {
                            console.warn("Could not parse existing pixel data. Using local state.", e);
                        }
                    } 

                    const oldPixel = pixelsData[cellIndex] || { color: BG_COLOR, userId: null };

                    // 1. Calculate Score Delta
                    let scoreDelta = 0;
                    
                    const normalizedNewColor = newColor.toUpperCase();
                    const normalizedOldColor = oldPixel.color.toUpperCase();
                    const normalizedBgColor = BG_COLOR.toUpperCase();

                    if (normalizedNewColor === normalizedBgColor && normalizedOldColor !== normalizedBgColor) {
                        scoreDelta = -1; // Erasing
                    } else if (normalizedNewColor !== normalizedBgColor && normalizedOldColor === normalizedBgColor) {
                        scoreDelta = 1; // Painting a new spot
                    }

                    // 2. Update the Pixel Data
                    if (normalizedNewColor !== normalizedOldColor) {
                        pixelsData[cellIndex] = {
                            color: newColor,
                            userId: userId
                        };

                        if (docSnapshot.exists()) {
                            transaction.update(docRef, { pixels: JSON.stringify(pixelsData) });
                        } else {
                            transaction.set(docRef, { pixels: JSON.stringify(pixelsData) });
                        }
                        

                        // 3. Update the Score Document (if delta is non-zero)
                        if (scoreDelta !== 0) {
                            const scoreRef = getLeaderboardDocRef(userId);
                            const scoreDoc = await transaction.get(scoreRef);
                            let currentScore = 0;
                            let displayName = userId.substring(0, 8); 

                            if (scoreDoc.exists()) {
                                const scoreData = scoreDoc.data();
                                currentScore = scoreData.score || 0;
                                displayName = scoreData.displayName || displayName;
                            }

                            const newScore = Math.max(0, currentScore + scoreDelta);

                            transaction.set(scoreRef, {
                                userId: userId,
                                displayName: displayName,
                                score: newScore,
                                lastUpdate: new Date().toISOString()
                            });
                        }
                    }
                });
                // console.log(`Transaction successful. Pixel ${cellIndex} updated.`);

            } catch (e) {
                console.error("Transaction failed (Write blocked, likely by ban/rules):", e);
                document.getElementById('user-status').textContent = "Write Failed (Check Ban Status).";
            }
        }


        /**
         * Attaches a real-time listener to the leaderboard collection and updates the UI.
         */
        function setupLeaderboardListener() {
            if (!db) return;
            const leaderboardCollectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            const q = query(leaderboardCollectionRef);

            onSnapshot(q, (snapshot) => {
                const scores = [];
                let userCurrentScore = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    scores.push(data);
                    if (doc.id === userId) {
                        userCurrentScore = data.score || 0;
                    }
                });

                // Sort scores descending
                scores.sort((a, b) => (b.score || 0) - (a.score || 0));

                const list = document.getElementById('leaderboard-list');
                const userScoreDisplay = document.getElementById('user-score-display');

                userScoreDisplay.textContent = userCurrentScore.toString();
                list.innerHTML = ''; // Clear the list

                if (scores.length === 0) {
                    list.innerHTML = '<li class="text-sm italic text-gray-500">No one has placed a pixel yet...</li>';
                } else {
                    scores.slice(0, 10).forEach((item, index) => {
                        const li = document.createElement('li');
                        const isCurrentUser = item.userId === userId;
                        
                        let name = item.displayName || item.userId.substring(0, 8);
                        
                        const colorClass = isCurrentUser ? 'text-[#ffcc33] font-extrabold' : 'text-[#4cd964]';
                        const backgroundClass = isCurrentUser ? 'bg-[#30363d] p-2 rounded-lg' : '';

                        li.className = backgroundClass;
                        li.innerHTML = `<div class="flex justify-between items-center">
                                            <span class="font-mono text-base mr-2 ${colorClass}">#${index + 1} ${name}</span>
                                            <span class="text-3xl font-black ${colorClass}">${item.score}</span>
                                        </div>`;
                        list.appendChild(li);
                    });
                }

            }, (error) => {
                console.error("Error fetching leaderboard:", error);
            });
        }


        // --- Event Listeners and Initial Setup ---

        const colorPicker = document.getElementById('color-picker');
        const colorDisplay = document.getElementById('current-color-display');
        const reAuthButton = document.getElementById('reauth-button');

        colorPicker.addEventListener('input', (e) => {
            currentColor = e.target.value;
            colorDisplay.textContent = currentColor.toUpperCase();
            colorDisplay.classList.remove('text-white');
            colorDisplay.style.color = currentColor;
        });

        document.getElementById('eraser-button').addEventListener('click', () => {
            currentColor = BG_COLOR;
            colorPicker.value = BG_COLOR;
            colorDisplay.textContent = 'ERASER (WHITE)';
            colorDisplay.style.color = '#FFFFFF';
        });
        
        reAuthButton.addEventListener('click', reAuthenticate);

        // Initial setup for color display
        colorDisplay.style.color = currentColor;

        // Render canvas structure immediately
        renderCanvas();
        // Authentication listener setup is in the initialization block (setupAuthListener)
    </script>
</body>
</html>
