<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Emoji Pixel Canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --pixel-size: 20px;
            --grid-size: 25;
            --canvas-width: calc(var(--pixel-size) * var(--grid-size));
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Light background */
            color: #1f2937;
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        #canvas-grid {
            display: grid;
            grid-template-columns: repeat(var(--grid-size), var(--pixel-size));
            grid-template-rows: repeat(var(--grid-size), var(--pixel-size));
            width: var(--canvas-width);
            height: var(--canvas-width);
            border: 5px solid #6366f1; /* Primary blue border */
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            margin: auto;
            image-rendering: pixelated;
        }
        .pixel {
            width: var(--pixel-size);
            height: var(--pixel-size);
            background-color: #FFFFFF; /* Default white background */
            cursor: crosshair;
            transition: background-color 0.05s ease-out;
            border: 1px solid #e5e7eb;
        }
        /* Mobile responsiveness adjustments */
        @media (max-width: 768px) {
            :root {
                --pixel-size: 13px; /* Smaller pixels on mobile */
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-[#6366f1] mb-2 drop-shadow-sm">üé® Collaborative Pixel Art</h1>
            <p id="app-load-status" class="text-sm font-medium text-gray-500">Initializing Application...</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Controls Column -->
            <div class="col-span-1 space-y-6 order-2 lg:order-1">
                
                <!-- TOP CARD: Authentication & User Status -->
                <div class="card p-6 rounded-xl border-l-4 border-indigo-500">
                    <h2 class="text-xl font-bold mb-3 text-[#4338ca]">üîë Connection Status</h2>
                    <p id="user-status" class="text-lg font-bold text-red-500 mb-4">Awaiting Sign-In...</p>
                    
                    <p class="text-sm font-medium break-words text-gray-500 mb-4">
                        <span class="font-bold">Your ID:</span> 
                        <span id="user-id-display" class="text-xs italic">Loading...</span>
                    </p>

                    <!-- Auth Buttons -->
                    <div class="space-y-2">
                        <button id="reauth-button" class="w-full p-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                            üîÑ Sign In with Original Token
                        </button>
                        <button id="anon-signin-button" class="w-full p-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-gray-300">
                            üë§ Try Anonymously
                        </button>
                    </div>
                </div>

                <!-- Tools Card -->
                <div class="card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-[#4338ca]">üõ†Ô∏è Tools & Color</h2>
                    
                    <!-- Color Picker -->
                    <div class="mb-4">
                        <label for="color-picker" class="block text-sm font-medium mb-2">Select Paint Color</label>
                        <input type="color" id="color-picker" value="#ef4444" class="w-full h-12 p-1 border-2 border-indigo-500 rounded-lg cursor-pointer transform hover:scale-[1.02] transition duration-200">
                    </div>

                    <!-- Erase Button -->
                    <button id="eraser-button" class="w-full p-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-red-400 mb-4">
                        üßπ Select Eraser (Loses Score)
                    </button>
                    
                    <p class="text-xs text-gray-500 mt-3 text-center">
                        Current Tool: <span id="current-color-display" class="font-bold text-red-500">#EF4444</span>
                    </p>
                </div>
            </div>

            <!-- Canvas Column -->
            <div class="col-span-1 lg:col-span-1 flex justify-center items-start order-1 lg:order-2">
                <div id="canvas-grid" class="rounded-xl overflow-hidden">
                    <!-- Pixels will be dynamically generated here -->
                </div>
            </div>

            <!-- Leaderboard & Online Users Column -->
            <div class="col-span-1 space-y-6 order-3 lg:order-3">
                
                <!-- Who's Online -->
                <div class="card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-green-600">üü¢ Who's Online (<span id="online-count">0</span>)</h2>
                    <ul id="online-users-list" class="space-y-2 text-gray-700">
                        <li class="text-sm italic text-gray-400">Checking...</li>
                    </ul>
                </div>

                <!-- Leaderboard -->
                <div class="card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-600">üèÜ Top Artists</h2>
                    <ol id="leaderboard-list" class="space-y-3 text-gray-700">
                        <li class="text-sm italic text-gray-400">No scores yet...</li>
                    </ol>
                    <div class="mt-6 p-3 bg-yellow-100 text-gray-900 rounded-lg text-center border-l-4 border-yellow-500">
                        <div class="text-lg font-semibold">Your Score</div>
                        <div id="user-score-display" class="text-5xl font-black text-yellow-700">0</div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration & Global State (START) ---
        setLogLevel('Debug');
        
        const GRID_SIZE = 25;
        const BG_COLOR = '#FFFFFF';
        const HEARTBEAT_INTERVAL_MS = 10000;
        const OFFLINE_THRESHOLD_MS = 30000;

        let currentColor = document.getElementById('color-picker').value;
        let auth, db;
        let userId = null;
        let pixelGrid = Array(GRID_SIZE * GRID_SIZE).fill(0).map(() => ({ color: BG_COLOR, userId: null }));
        let isAuthReady = false;
        let isAuthListenerActive = false; 

        // 1. Mandatory App ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // 2. Robust Config Parsing using __firebase_config
        const firebaseConfig = (() => {
            try {
                const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const parsedConfig = JSON.parse(configString);
                if (Object.keys(parsedConfig).length > 0 && parsedConfig.projectId) {
                    document.getElementById('app-load-status').textContent = "Firebase Configuration Loaded.";
                    return parsedConfig;
                }
            } catch (e) {
                console.error("Could not parse __firebase_config. Using dummy config.", e);
            }
            // Fallback for environment outside Canvas
            document.getElementById('app-load-status').textContent = "WARNING: Using Dummy Firebase Config. Auth will fail.";
            return { apiKey: "dummy", authDomain: "dummy", projectId: "dummy-pixel-art" };
        })();
        
        // 3. Mandatory Auth Token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Configuration & Global State (END) ---


        // --- Initialization ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupAuthListener(); 
        } catch(e) {
            document.getElementById('user-status').textContent = "FATAL ERROR: Firebase Init Failed. Check console.";
            console.error("FATAL: Could not initialize Firebase services.", e);
        }
        
        // --- Firestore References ---
        const getCanvasDocRef = () => doc(db, `artifacts/${appId}/public/data/canvas_state/current`);
        const getLeaderboardDocRef = (uid) => doc(db, `artifacts/${appId}/public/data/leaderboard/${uid}`);
        const getPresenceDocRef = (uid) => doc(db, `artifacts/${appId}/public/data/presence/${uid}`);


        // --- Authentication & Presence ---

        function setupAuthListener() {
            if (isAuthListenerActive || !auth) return;
            isAuthListenerActive = true;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    document.getElementById('user-status').classList.remove('text-red-500');
                    document.getElementById('user-status').classList.add('text-green-600');
                    document.getElementById('user-status').textContent = `‚úÖ Connected as ${userId.substring(0, 8)}...`;
                    isAuthReady = true;

                    setupCanvasListener();
                    setupLeaderboardListener();
                    setupOnlineUsersListener();
                    startPresenceHeartbeat();

                } else {
                    document.getElementById('user-status').textContent = `Awaiting Sign-In...`;
                    document.getElementById('user-status').classList.add('text-red-500');
                    document.getElementById('user-status').classList.remove('text-green-600');
                    // Automatically try custom sign-in if token exists
                    if (initialAuthToken) {
                        signInUser('custom');
                    }
                }
            });
        }
        
        async function signInUser(mode) {
            if (!auth) return;
            
            document.getElementById('user-status').textContent = `Attempting sign-in (${mode})...`;
            
            try {
                if (mode === 'custom' && initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else if (mode === 'anonymous') {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error(`Error during ${mode} authentication:`, error);
                document.getElementById('user-status').textContent = "‚ùå Auth Failed (Check Security Rules/Token).";
                isAuthReady = false; 
            }
        }
        
        async function reAuthenticate(mode) {
            if (!auth) return;
            document.getElementById('user-status').textContent = "Re-authenticating...";
            isAuthReady = false;
            
            try {
                await signOut(auth);
                await signInUser(mode);
            } catch (error) {
                console.error("Error during re-authentication sequence:", error);
                document.getElementById('user-status').textContent = "‚ùå Re-authentication Failed.";
            }
        }

        function startPresenceHeartbeat() {
            if (!db || !userId) return;

            const updatePresence = async () => {
                if (!userId) return;
                const docRef = getPresenceDocRef(userId);
                try {
                    await setDoc(docRef, { 
                        userId: userId, 
                        lastActive: Date.now(),
                        displayName: userId.substring(0, 8) 
                    }, { merge: true });
                } catch (e) {
                    // Silent fail for heartbeat on write block
                }
            };

            updatePresence();
            setInterval(updatePresence, HEARTBEAT_INTERVAL_MS);
        }

        function setupOnlineUsersListener() {
            if (!db) return;
            const presenceCollectionRef = collection(db, `artifacts/${appId}/public/data/presence`);
            
            onSnapshot(presenceCollectionRef, (snapshot) => {
                const onlineUsers = [];
                const now = Date.now();
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const lastActive = data.lastActive || 0;
                    
                    if (now - lastActive < OFFLINE_THRESHOLD_MS) {
                        onlineUsers.push(data);
                    }
                });

                const list = document.getElementById('online-users-list');
                const countDisplay = document.getElementById('online-count');
                
                countDisplay.textContent = onlineUsers.length.toString();
                list.innerHTML = '';

                if (onlineUsers.length === 0) {
                    list.innerHTML = '<li class="text-sm italic text-gray-400">No one here... get painting!</li>';
                } else {
                    onlineUsers.forEach((item) => {
                        const li = document.createElement('li');
                        const isCurrentUser = item.userId === userId;
                        const name = item.displayName || item.userId.substring(0, 8);
                        
                        li.className = isCurrentUser ? 'font-bold text-indigo-600' : 'text-gray-700';
                        li.innerHTML = `<span class="mr-2">üë§</span> ${name} ${isCurrentUser ? '(You)' : ''}`;
                        list.appendChild(li);
                    });
                }

            }, (error) => {
                console.error("Error fetching online users:", error);
            });
        }


        // --- Canvas & Leaderboard Logic ---

        function renderCanvas() {
            const canvasGrid = document.getElementById('canvas-grid');
            const pixelElements = canvasGrid.querySelectorAll('.pixel');

            if (pixelElements.length === 0) {
                canvasGrid.innerHTML = '';
                for (let index = 0; index < GRID_SIZE * GRID_SIZE; index++) {
                    const pixel = pixelGrid[index] || { color: BG_COLOR, userId: null };
                    const pixelDiv = document.createElement('div');
                    pixelDiv.classList.add('pixel');
                    pixelDiv.style.backgroundColor = pixel.color || BG_COLOR;
                    
                    pixelDiv.addEventListener('click', () => {
                        updateSinglePixelAndScore(index, currentColor);
                    });
                    canvasGrid.appendChild(pixelDiv);
                }
            } else {
                pixelGrid.forEach((pixel, index) => {
                    pixelElements[index].style.backgroundColor = pixel.color || BG_COLOR;
                });
            }
        }

        function setupCanvasListener() {
            if (!db) return;
            const docRef = getCanvasDocRef();
            
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    if (data.pixels) {
                        try {
                            const newPixels = JSON.parse(data.pixels);
                            if (Array.isArray(newPixels) && newPixels.length === GRID_SIZE * GRID_SIZE) {
                                pixelGrid = newPixels;
                                renderCanvas();
                            }
                        } catch (e) {
                            console.error("Error parsing pixel data:", e);
                        }
                    }
                } else {
                    renderCanvas(); 
                }
            }, (error) => {
                console.error("Error setting up canvas listener:", error);
            });
        }

        async function updateSinglePixelAndScore(cellIndex, newColor) {
            if (!isAuthReady || !userId || !db) {
                document.getElementById('user-status').textContent = "‚ö†Ô∏è Authentication Required to Paint!";
                console.warn("Write blocked: Authentication not ready or missing database.");
                return;
            }

            const docRef = getCanvasDocRef();

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(docRef);
                    let pixelsData = Array(GRID_SIZE * GRID_SIZE).fill(0).map(() => ({ color: BG_COLOR, userId: null }));

                    if (docSnapshot.exists()) {
                        try {
                            const parsedData = JSON.parse(docSnapshot.data().pixels);
                            if (Array.isArray(parsedData) && parsedData.length === GRID_SIZE * GRID_SIZE) {
                                pixelsData = parsedData;
                            }
                        } catch (e) {
                            console.warn("Could not parse existing pixel data. Using default state for transaction.", e);
                        }
                    } 

                    const oldPixel = pixelsData[cellIndex] || { color: BG_COLOR, userId: null };

                    let scoreDelta = 0;
                    const normalizedNewColor = newColor.toUpperCase();
                    const normalizedOldColor = (oldPixel.color || BG_COLOR).toUpperCase();
                    const normalizedBgColor = BG_COLOR.toUpperCase();

                    if (normalizedNewColor === normalizedOldColor) {
                        return;
                    }

                    if (normalizedNewColor === normalizedBgColor && normalizedOldColor !== normalizedBgColor) {
                        scoreDelta = -1;
                    } else if (normalizedNewColor !== normalizedBgColor && normalizedOldColor === normalizedBgColor) {
                        scoreDelta = 1;
                    }

                    pixelsData[cellIndex] = {
                        color: newColor,
                        userId: userId
                    };

                    if (docSnapshot.exists()) {
                        transaction.update(docRef, { pixels: JSON.stringify(pixelsData) });
                    } else {
                        transaction.set(docRef, { pixels: JSON.stringify(pixelsData) });
                    }
                    
                    if (scoreDelta !== 0) {
                        const scoreRef = getLeaderboardDocRef(userId);
                        const scoreDoc = await transaction.get(scoreRef);
                        let currentScore = 0;
                        let displayName = userId.substring(0, 8); 

                        if (scoreDoc.exists()) {
                            const scoreData = scoreDoc.data();
                            currentScore = scoreData.score || 0;
                            displayName = scoreData.displayName || displayName;
                        }

                        const newScore = Math.max(0, currentScore + scoreDelta);

                        transaction.set(scoreRef, {
                            userId: userId,
                            displayName: displayName,
                            score: newScore,
                            lastUpdate: new Date().toISOString()
                        });
                    }
                });
            } catch (e) {
                console.error("Transaction failed (Write blocked, likely by ban/rules):", e);
                document.getElementById('user-status').textContent = "‚ùå Write Failed (Check Console for Errors).";
            }
        }

        function setupLeaderboardListener() {
            if (!db) return;
            const leaderboardCollectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            const q = query(leaderboardCollectionRef);

            onSnapshot(q, (snapshot) => {
                const scores = [];
                let userCurrentScore = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    scores.push(data);
                    if (doc.id === userId) {
                        userCurrentScore = data.score || 0;
                    }
                });

                scores.sort((a, b) => (b.score || 0) - (a.score || 0));

                const list = document.getElementById('leaderboard-list');
                const userScoreDisplay = document.getElementById('user-score-display');

                userScoreDisplay.textContent = userCurrentScore.toString();
                list.innerHTML = ''; 

                if (scores.length === 0) {
                    list.innerHTML = '<li class="text-sm italic text-gray-400">No one has placed a pixel yet...</li>';
                } else {
                    scores.slice(0, 10).forEach((item, index) => {
                        const li = document.createElement('li');
                        const isCurrentUser = item.userId === userId;
                        
                        let name = item.displayName || item.userId.substring(0, 8);
                        
                        const colorClass = isCurrentUser ? 'text-indigo-600 font-extrabold' : 'text-gray-800';
                        const backgroundClass = isCurrentUser ? 'bg-indigo-50 p-2 rounded-lg' : '';

                        li.className = backgroundClass;
                        li.innerHTML = `<div class="flex justify-between items-center text-lg">
                                            <span class="font-mono mr-2 ${colorClass}">#${index + 1} ${name}</span>
                                            <span class="text-3xl font-black ${colorClass}">${item.score}</span>
                                        </div>`;
                        list.appendChild(li);
                    });
                }

            }, (error) => {
                console.error("Error fetching leaderboard:", error);
            });
        }


        // --- Event Listeners and Initial Setup ---

        const colorPicker = document.getElementById('color-picker');
        const colorDisplay = document.getElementById('current-color-display');
        const reAuthButton = document.getElementById('reauth-button');
        const anonSigninButton = document.getElementById('anon-signin-button');

        colorPicker.addEventListener('input', (e) => {
            currentColor = e.target.value;
            colorDisplay.textContent = currentColor.toUpperCase();
            colorDisplay.style.color = currentColor;
        });

        document.getElementById('eraser-button').addEventListener('click', () => {
            currentColor = BG_COLOR;
            colorPicker.value = BG_COLOR;
            colorDisplay.textContent = 'ERASER (WHITE)';
            colorDisplay.style.color = '#1f2937'; 
        });
        
        reAuthButton.addEventListener('click', () => reAuthenticate('custom'));
        anonSigninButton.addEventListener('click', () => reAuthenticate('anonymous'));

        colorDisplay.style.color = currentColor;
        renderCanvas();
    </script>
</body>
</html>
